<!DOCTYPE html>
<html>
<head>
    <title>OpenBeta</title>
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta charset="utf-8" />
    <meta name='viewport' content='width=device-width,initial-scale=1,user-scalable=yes' />
    <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.0-rc.1/leaflet.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.0-rc.1/MarkerCluster.css" />
    <link rel="stylesheet" type="text/css" href="http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.0-rc.1/MarkerCluster.Default.css" />
    <link rel="stylesheet" type="text/css" href="lib/OverPassLayer.css" />
    <link rel="stylesheet" type="text/css" href="lib/leaflet-draw/leaflet.draw.css" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }
        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
        #delete, #export {
            position: absolute;
            top:250px;
            right:10px;
            z-index: 500;
            background:white;
            color:black;
            padding:6px;
            border-radius:4px;
            font-family: 'Helvetica Neue';
            cursor: pointer;
            font-size:12px;
            text-decoration:none;
        }
        #export {
            top:200px;
        }
    </style>
</head>

<body>
    <div id="map" style="width: 100%; min-height: 100vh; max-height: 100%;"></div>
    <div id='delete'>Delete Features</div>
    <a href='#' id='export'>Export Features</a>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.2/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-ajax/2.1.0/leaflet.ajax.min.js"></script>
    <script src='http://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.0.0-rc.1/leaflet.markercluster.js'></script>
    <script src='https://code.jquery.com/jquery-1.11.0.min.js'></script>
    <script src='http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js'></script>

    <script src='lib/OverPassLayer.bundle.js'></script>
    <script src='lib/leaflet-draw/leaflet.draw.js'></script>
    <script src='map.js'></script>

    <script>
        var mapCenter=[36.1614211,-115.4500339]; // Red Rock Caynon
        var theMap = prepareMap("map", mapCenter);
        queryOverpass(theMap.clustersLayer, mapCenter);

        $(function() {

            editableLayers = prepareEditor(theMap.mapLayer);

            $("#export").click(function(){
                submitData(editableLayers);
            });

		}); // main jquery ready function



		function submitData(editableLayers) {
            var url = "http://localhost:5000/boundaries";
        	//var jqxhr = $.post("http://localhost:5000/boundaries",
            //                 _getJSONFromDrawing(editableLayers));
            //jqxhr.error(function(){
            //    alert("Error connecting to API server");
            //});

            $.ajax({
                type: "POST",
                url: url,
                data: _getJSONFromDrawing(editableLayers),
                success: function(data, textStatus, jqXHR ) { 
                            alert("Success!")
                        },
                error: function(data, textStatus, jqXHR ) { 
                            alert("Error!" + textStatus)
                        },
                dataType: "json",
                processData: false,
                contentType: "application/json"
            });
    	}

        function _getJSONFromDrawing(layer) {
            var data = editableLayers.toGeoJSON();
            //console.log(JSON.stringify(data))
            //var convertedData = encodeURIComponent(JSON.stringify(data));
            //console.log(convertedData);
            return JSON.stringify(data); 
        }


        function prepareEditor(map) {
            var editableLayers = new L.FeatureGroup();
            map.addLayer(editableLayers);

            var options = {
                position: 'topright',
                draw: {
                    polyline: false,
                    polygon: {
                        allowIntersection: false, // Restricts shapes to simple polygons
                        drawError: {
                            color: '#f357a1', // Color the shape will turn when intersects
                            message: '<strong>Oh snap!<strong> you can\'t draw that!' // Message that will show when intersect
                        },
                        shapeOptions: {
                            color: '#212f3c'
                        }
                    },
                    circle: false, // Turns off this drawing tool
                    rectangle: false,
                    marker: false,
                },
                edit: {
                    featureGroup: editableLayers, //REQUIRED!!
                    remove: false
                }

            };
 
            var drawControl = new L.Control.Draw(options);
            map.addControl(drawControl);

            map.on(
                L.Draw.Event.CREATED,
                function (e) {
                    var type = e.layerType,
                    layer = e.layer;

                    if (type === 'marker') {
                        layer.bindPopup('A popup!');
                    }
                editableLayers.addLayer(layer);
                }

            );
            map.on(
                L.Draw.Event.DRAWSTOP,
                function (e) {
                    var type = e.layerType,
                    layer = e.layer;

                    console.log(layer)
                    alert("Do you want to save " + layer);
                //editableLayers.addLayer(layer);
                }

            );

            return editableLayers;
        } //prepareEditor


        // on click, clear all layers
        document.getElementById('delete').onclick = function(e) {
            editableLayers.clearLayers();
        }

</script>
</body>
</html>
